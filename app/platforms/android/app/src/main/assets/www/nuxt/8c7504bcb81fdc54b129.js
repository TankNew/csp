(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{269:function(e,t,s){"use strict";s.d(t,"b",function(){return r}),s.d(t,"a",function(){return o});s(40);var n=s(267),a=s(74),i=s(41),r=function(e){var t=e.UserDomain,s=e.UserName,r=e.UserPass,o=e.SessionId,c=n.a.kefuUrl+"login";a.a.post(c,{domain:t,username:s,password:r,sessionid:o}).then(function(e){var n=e.data;if(0===n.error){var a={UserDomain:t,UserName:s,NickName:n.nickname,HeadImg:n.headimage,UserSign:n.sign};Object(i.c)(a),Object(i.d)(o),window.location.replace("/#/home")}else console.error(n.content)}).catch(function(e){console.error(e)})},o=function(){Object(i.e)(),window.location.replace("".concat(window.location.protocol,"//").concat(window.location.host))}},270:function(e,t,s){var n=s(283);"string"==typeof n&&(n=[[e.i,n,""]]),n.locals&&(e.exports=n.locals);(0,s(4).default)("415ffb8a",n,!0,{sourceMap:!1})},282:function(e,t,s){"use strict";var n=s(270);s.n(n).a},283:function(e,t,s){(e.exports=s(3)(!1)).push([e.i,"",""])},299:function(e,t,s){"use strict";s.r(t);s(27),s(23);var n=s(31),a=s.n(n),i=s(276),r=s(37),o=(s(98),s(99),s(277)),c={name:"Slider",components:{swiper:o.swiper,swiperSlide:o.swiperSlide},props:{isChat:{type:Boolean,default:!1},isSetting:{type:Boolean,default:!1}},data:function(){return{horizontalSwiperOptions:{slidesPerView:"auto",initialSlide:1,direction:"horizontal",slideToClickedSlide:!0}}},computed:{horizontalSwiper:function(){return this.$refs.horizontalSwiper.swiper}},mounted:function(){var e=this;setTimeout(function(){e._initMenuWidth()},20)},methods:{_initMenuWidth:function(){this.horizontalSwiper.updateSlides(),this.horizontalSwiper.slideTo(1,0,!1)},goto:function(e){this.horizontalSwiper.slideTo(e)},back:function(){var e=this;this.$nextTick(function(){e.horizontalSwiper.slideTo(1,0,!1)})},onSlideEnd:function(){1===this.horizontalSwiper.activeIndex&&this.$emit("onSlideEnd")},getRandomColor:function(){return"#"+("00000"+(16777215*Math.random()+.5>>0).toString(16)).slice(-6)}}},u=(s(282),s(1)),l=Object(u.a)(c,function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("swiper",{ref:"horizontalSwiper",staticClass:"h-100",attrs:{options:e.horizontalSwiperOptions},on:{slideChangeTransitionEnd:e.onSlideEnd}},[e.isSetting?e._e():s("swiper-slide",{ref:"left",staticClass:"leftBar"},[e._t("left")],2),e._v(" "),s("swiper-slide",{ref:"content",staticClass:"main-body"},[e._t("content")],2),e._v(" "),e.isChat?s("swiper-slide",{ref:"right",staticClass:"right-chat"},[e._t("right")],2):e._e()],1)},[],!1,null,"6d89f066",null);l.options.__file="Slider.vue";var f=l.exports,h=s(267),m=s(268),d=s(269),g=null,v={username:"",nickname:"",headimage:"/imgs/visitor.png",chats:[]},p={code:100,username:"系统",time:""},C={name:"Home",layout:"panel",middleware:"authenticated",components:{slider:f,scroll:i.a},asyncData:function(e){},data:function(){return{dismissSecs:3,dismissCountDown:0,kefuinfo:{username:null,headimage:null,nickname:null,domain:null,sign:null,state:1},companyInfo:{},serverstatus:"等待……",isCollapsed:!1,isSetting:!1,pages:[{name:"对话列表",url:"/home/control-panel/chat-list",icon:"fa-comment",menu:!0},{name:"等待访客",url:"/home/control-panel/waitting",icon:"fa-user-friends",menu:!0},{name:"在线客服",url:"/home/control-panel/online",icon:"fa-user-clock",menu:!0},{name:"设置",url:"/home/setting",menu:!1}],currentPage:{},currentChat:{chats:[]},isChat:!1,userWatting:[],kefuList:[],systemInfo:[],systemInfoNew:{},count:0,chatIndex:0,userChatTabs:[],userHold:[],message:""}},computed:a()({},Object(r.b)(["isAuthenticated","currentUser","macAddress"]),Object(r.b)({currentPath:"pathName/currentPath"})),watch:{$route:function(e){window.scrollTo(0,0)},systemInfo:function(e){var t=e.length;this.systemInfoNew=e[t-1]}},created:function(){this.setCurrentPage(),this.setPathName(this.currentPage.name),this.kefuinfo.username=this.currentUser.UserName,this.kefuinfo.headimage=this.currentUser.HeadImg,this.kefuinfo.nickname=this.currentUser.NickName,this.kefuinfo.domain=this.currentUser.UserDomain,this.kefuinfo.sign=this.currentUser.UserSign,this.getCompanyInfo(),this.connect()},methods:a()({countDownChanged:function(e){this.dismissCountDown=e},showAlert:function(){this.dismissCountDown=this.dismissSecs},setCurrentPage:function(e){var t=this,s=t.$router.history.current.path;console.log(s),t.currentPage.url=e||s;var n=!1;t.pages.forEach(function(e){e.url===t.currentPage.url&&(t.currentPage=JSON.parse(JSON.stringify(e)),n=!0)}),n?e!==s&&t.$router.push({path:t.currentPage.url}):t.setCurrentPage("/home/control-panel/chat-list"),"/home/setting"===t.currentPage.url?t.isSetting=!0:t.isSetting=!1},alertInfo:function(e,t){console.info(e)},alertError:function(e){console.error(e)}},Object(r.c)({setPathName:"pathName/set"}),{changePage:function(e){this.setCurrentPage(e),this.setPathName(this.currentPage.name)},leftBarChange:function(){this.$refs.slider.goto(0),this.isCollapsed=!0},leftBarClose:function(){this.$refs.slider.goto(1),this.isCollapsed=!1},rightBack:function(){this.onSlideEnd(),this.$refs.slider.goto(1)},onSlideEnd:function(){this.isChat=!1,this.currentChat={chats:[]},this.setPathName(this.currentPage.name)},setting:function(){var e=this;e.leftBarClose(),e.isSetting=!0,e.$nextTick(function(){e.changePage("/home/setting")})},back:function(){this.isSetting=!1,this.$refs.slider.back(),this.changePage("/home/control-panel/chat-list")},reload:function(){console.log("Page reloading")},setCurrentChat:function(e){var t=this,s=this.userHold.indexOf(e.username);s>-1&&this.userHold.splice(s,1),t.isChat=!0,t.currentChat=e,t.setCurrentPage("/home/control-panel/chat-list"),t.$nextTick(function(){t.setPathName("与 ".concat(t.currentChat.username," 对话中")),t.$refs.scrollpanel.refresh(),t.$refs.slider.goto(2)})},changeServerStatus:function(e){this.serverstatus=e},rfalse:function(){return!1},logout:function(){Object(d.a)()},getCompanyInfo:function(){var e=this,t=h.a.kefuUrl+"GetDomainInfo";this.$httpform.post(t,{domain:e.kefuinfo.domain,username:e.kefuinfo.username,sign:e.kefuinfo.sign,sessionid:e.macAddress}).then(function(t){var s=t.data;0===s.error?e.companyInfo=JSON.parse(s.content):e.alertInfo(s.error+":"+s.detail)}).catch(function(t){e.alertError("系统错误")})},reConnect:function(){g.close(),g=null,this.connect()},connect:function(){var e=this,t="MozWebSocket"in window?"MozWebSocket":"WebSocket"in window?"WebSocket":null,s="ws://".concat(m.wsUrl,"/token?name=").concat(e.kefuinfo.username,"&sign=").concat(encodeURIComponent(e.kefuinfo.sign),"&domain=").concat(e.kefuinfo.domain,"&admin=true&islogin=false&uniqueid=").concat(e.macAddress);(g=new window[t](s)).onclose=function(t){e.userChatTabs=[],e.userHold=[],e.userWatting=[],e.kefuList=[],e.count=0,e.changeServerStatus("中断")},g.onopen=function(t){e.changeServerStatus("连接中...")},g.onmessage=function(t){!function(t){e.changeServerStatus("正常"),e.Revice(t.data)}(t)},g.onerror=function(t){e.changeServerStatus("连接错误")}},Revice:function(e){var t,s=this;console.log(e);try{var n=JSON.parse(e);switch(n.code){case 0:s.chatMessage(n,!1);break;case 1:s._pushUserWatting(n.username,n.islogin);break;case 2:s._removeUserWatting(n.username);break;case 3:s._pushKefu(n.username);break;case 4:s._removeKefu(n.username);break;case 5:s._removeUserWatting(n.username),s._removeChatTab(n.username);break;case 11:t=[],s.userWatting=[],n.userwaitting.forEach(function(e){if(e.islogin)t.push(e.username);else{var n=JSON.parse(JSON.stringify(v));n.username=e.username,n.islogin=e.islogin,n.headimage="/imgs/visitor.png",s.userWatting.push(n)}}),t.length>0&&s._getUserInfo(t);break;case 13:s.kefuList=[],t=[],n.adminlist.forEach(function(e){t.push(e.username)}),t.length>0&&s._getKefuInfo(t)}}catch(t){var a=JSON.parse(JSON.stringify(p));a.code=e,s._pushSystemInfo(a)}},Event:function(e,t){switch(e){case 1:return"访客：".concat(t," 等待中");case 2:return"访客：".concat(t," 已被接入");case 5:return"访客：".concat(t," 离线");case 3:return"客服：".concat(t," 上线");case 4:return"客服：".concat(t," 离线");case 11:return"访客列表刷新";case 13:return"刷新客服列表";default:return"系统：".concat(e)}},_pushSystemInfo:function(e){e.time=h.a.myTime.UnixToDate(h.a.myTime.CurTime(),!0,8),this.systemInfo.push(e),this.showAlert()},_getKefuInfo:function(e){var t=this,s=h.a.kefuUrl+"GetKefuList",n={domain:t.kefuinfo.domain,username:t.kefuinfo.username,sign:t.kefuinfo.sign,sessionid:t.macAddress,content:e};this.$httpform.post(s,n).then(function(e){var s=e.data;0===s.error?t.kefuList=JSON.parse(s.content):s.error?t.alertInfo(s.error+":"+s.content):t.alertError("通讯错误")}).catch(function(e){t.alertError("系统错误"),console.log(e)})},_getUserInfo:function(e){var t=this,s=h.a.kefuUrl+"GetVisitorList",n={domain:t.kefuinfo.domain,username:t.kefuinfo.username,sign:t.kefuinfo.sign,sessionid:t.macAddress,content:e};e.length>0&&this.$httpform.post(s,n).then(function(e){var s=e.data;if(0===s.error){var n=JSON.parse(s.content);n.forEach(function(e){e.islogin=!0}),t.userWatting.concat(n)}else t.alertInfo(s.error+":"+s.content)}).catch(function(e){t.alertError("系统错误"),console.log(e)})},_pushKefu:function(e){if(e!==this.kefuinfo.username){var t=[];t.push(e),t.length>0&&this._getKefuInfo(t)}},_removeKefu:function(e){var t=this;t.kefuList.forEach(function(s,n,a){s.username===e&&t.userWatting.splice(n,1)})},_pushUserWatting:function(e,t){var s=!0;if(this.userWatting.forEach(function(t){t.username===e&&(s=!1)}),this.userChatTabs.forEach(function(t){t.username===e&&(s=!1)}),s)if(t){var n=[];n.push(e),_getUserInfo(n)}else{var a=JSON.parse(JSON.stringify(v));a.username=e,a.islogin=t,this.userWatting.push(a)}},_removeUserWatting:function(e){var t=this;t.userWatting.forEach(function(s,n,a){s.username===e&&t.userWatting.splice(n,1)})},chatIn:function(e){var t=this;if(t.count<5){var s=t._loadUserStorage(e.username);s&&(e.chats=s.chats),t.userChatTabs.push(e),t.count++,t._removeUserWatting(e.username),t.sendCode(2001,e.username),t.$nextTick(function(){t.setCurrentChat(e)})}else t.alertInfo("您的客户等级只能同时接入5个会话")},chatOut:function(e,t){var s=this.currentChat.username;this.sendCode(2002,s),this._removeChatTab(s),t&&this._removeUserStorage(s)},chatMessage:function(e,t){var s,n;(t?(s=e.toUser,this.userChatTabs.forEach(function(t){t.username===e.toUser&&(n=t)})):(s=e.fromUser,this.userChatTabs.forEach(function(t){t.username===e.fromUser&&(n=t)})),null!=n)&&(n.chats.push(e),s!==this.currentChat.username?-1===this.userHold.indexOf(s)&&this.userHold.push(s):this.refresh())},chatSubmit:function(e,t){if(!t.shiftKey){if(null===this.message||""===this.message)this.alertInfo("您还没有输入对话内容");else{var s={id:0,fromUser:this.kefuinfo.username,toUser:e,content:this.message,code:0,addTime:h.a.myTime.UnixToDate(h.a.myTime.CurTime(),!0,8)};this.chatMessage(s,!0),g.send(JSON.stringify(s)),this.message=null}return t.preventDefault(),!1}},refresh:function(){this.$refs.scrollpanel&&this.$refs.scrollpanel.refresh()},_removeChatTab:function(e){var t=this;t.userChatTabs.forEach(function(s,n,a){s.username===e&&(t.userChatTabs.splice(n,1),t.count--,t.onSlideEnd())})},_loadUserStorage:function(e){return null},_removeUserStorage:function(e){},_loadKefuStorage:function(e){},_removeKefuStorage:function(e){},sendCode:function(e,t){var s=null;switch(e){case 2001:s="欢迎您，"+this.kefuinfo.nickname+"很高兴为您服务";break;case 2002:s="感谢您的咨询，祝您生活愉快"}var n={id:0,fromUser:this.kefuinfo.username,toUser:t,content:s,code:e,addTime:h.a.myTime.UnixToDate(h.a.myTime.CurTime(),!0,8)};g.send(JSON.stringify(n))}}),beforeRouteUpdate:function(e,t,s){s()}},_=Object(u.a)(C,function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("section",{staticClass:"control-panel"},[s("slider",{ref:"slider",attrs:{"is-chat":e.isChat,"is-setting":e.isSetting},on:{onSlideEnd:e.onSlideEnd}},[s("div",{attrs:{slot:"left"},slot:"left"},[s("span",{staticClass:"left-shrink-icon",on:{click:e.leftBarClose}},[s("i",{staticClass:"fas fa-arrow-left"})]),e._v(" "),s("p",{staticClass:"lead mt-5"},[e._v(e._s(e.companyInfo.name))]),e._v(" "),s("div",{staticClass:"user-panel mt-3"},[s("div",{staticClass:"user-pic"},[s("img",{staticClass:"img-responsive img-rounded mCS_img_loaded",attrs:{src:"/imgs/64.png",alt:""}})]),e._v(" "),s("div",{staticClass:"user-info"},[s("span",{staticClass:"user-name"},[s("strong",[e._v(e._s(e.kefuinfo.nickname))])]),e._v(" "),s("span",{staticClass:"user-role"},[e._v(e._s(e.kefuinfo.domain))]),e._v(" "),s("div",{staticClass:"user-status"},[s("a",{attrs:{href:"javascript:void(0)"}},[s("span",{staticClass:"btn btn-success btn-sm",staticStyle:{padding:"0 0.2rem"}},[e._v("Online")])])])])]),e._v(" "),s("hr"),e._v(" "),s("ul",{staticClass:"user-toolbar"},[s("li",[s("a",{on:{click:e.setting}},[s("i",{staticClass:"fas fa-cog mr-1"}),e._v("设置\n          ")])]),e._v(" "),s("li",[s("a",{on:{click:e.reConnect}},[s("i",{staticClass:"fas fa-redo mr-1"}),e._v("重连\n          ")])]),e._v(" "),s("li",[s("a",{on:{click:e.logout}},[s("i",{staticClass:"fas fa-sign-out-alt mr-1"}),e._v("退出登录\n          ")])])])]),e._v(" "),s("div",{staticClass:"h-100",attrs:{slot:"content"},slot:"content"},[s("header",[s("b-alert",{staticClass:"small system-info mb-0",attrs:{show:e.dismissCountDown,variant:"info",dismissible:"",fade:""},on:{dismissed:function(t){e.dismissCountDown=0},"dismiss-count-down":e.countDownChanged}},[s("span",{staticClass:"system-info-text"},[s("i",{staticClass:"fas fa-circle mr-1"}),e._v(" "),s("span",{staticClass:"system-info-text-content"},[e._v(e._s(e.Event(e.systemInfoNew.code,e.systemInfoNew.username)))])])]),e._v(" "),s("div",{staticClass:"server-status"},[s("span",[s("i",{staticClass:"fas fa-server text-success mr-1"}),e._v("\n            服务器状态： "+e._s(e.serverstatus)+"\n          ")]),e._v(" "),s("span",[s("i",{staticClass:"fas fa-globe text-success mr-1"}),e._v("\n            "+e._s(e.kefuinfo.domain)+"\n          ")]),e._v(" "),s("span",[s("i",{staticClass:"fab fa-creative-commons text-success mr-1"}),e._v("版本：1.0.0\n          ")])]),e._v(" "),e.isSetting?s("div",{staticClass:"top_bg"},[s("div",{staticClass:"logo"},[s("i",{staticClass:"fas fa-chevron-left",on:{click:function(t){e.back()}}})]),e._v(" "),s("div",{staticClass:"top_title"},[e._v(e._s(e.currentPage.name))])]):s("div",{staticClass:"top_bg"},[s("div",{staticClass:"logo"},[s("img",{staticClass:"img-responsive",attrs:{src:e.kefuinfo.headimage,alt:""},on:{click:e.leftBarChange}})]),e._v(" "),s("div",{staticClass:"top_title"},[e._v(e._s(e.currentPage.name))])])],1),e._v(" "),s("nuxt-child",{ref:"home",attrs:{"is-setting":e.isSetting,"current-page":e.currentPage,pages:e.pages,"mac-address":e.macAddress,"user-chat-tabs":e.userChatTabs,"user-hold":e.userHold,"kefu-list":e.kefuList,"user-watting":e.userWatting},on:{alertInfo:e.alertInfo,alertError:e.alertError,chatIn:e.chatIn,setCurrentChat:e.setCurrentChat,chatOut:e.chatOut,reload:e.reload,leftBarClose:e.leftBarClose,changePage:e.changePage,back:e.back}})],1),e._v(" "),s("div",{staticClass:"h-100",attrs:{slot:"right"},slot:"right"},[s("header",[s("div",{staticClass:"server-status"},[s("span",[s("i",{staticClass:"fas fa-server text-success mr-1"}),e._v("\n            服务器状态： "+e._s(e.serverstatus)+"\n          ")]),e._v(" "),s("span",[s("i",{staticClass:"fas fa-globe text-success mr-1"}),e._v("\n            "+e._s(e.kefuinfo.domain)+"\n          ")]),e._v(" "),s("span",[s("i",{staticClass:"fab fa-creative-commons text-success mr-1"}),e._v("版本：1.0.0\n          ")])]),e._v(" "),s("div",{staticClass:"top_bg"},[s("a",{on:{click:e.rightBack}},[s("i",{staticClass:"fas fa-chevron-left mr-1"})]),e._v(" "),s("div",{staticClass:"top_title"},[e._v("与 "+e._s(e.currentChat.username)+" 对话中")])])]),e._v(" "),s("div",{staticClass:"w-100 h-100 position-relative"},[s("scroll",{ref:"scrollpanel",staticClass:"message-box-wrapper",attrs:{data:e.currentChat.chats,"auto-scroll":!0}},[s("div",{staticClass:"message-box-content"},[e.currentChat?s("ul",{staticClass:"mbox"},e._l(e.currentChat.chats,function(t,n){return s("li",{key:n,class:t.fromUser==e.kefuinfo.username?"replay":"receive"},[t.fromUser==e.kefuinfo.username?s("div",{staticClass:"headAndName"},[s("img",{attrs:{src:e.kefuinfo.headimage}})]):s("div",{staticClass:"headAndName"},[s("img",{attrs:{src:e.currentChat.headimage}})]),e._v(" "),s("p",{staticClass:"pointer"},[e._v(e._s(t.content))]),e._v(" "),s("div",{staticClass:"clear"})])})):e._e()])]),e._v(" "),s("div",{staticClass:"text-center"},[s("a",{staticClass:"btn btn-link btn-sm text-primary",on:{click:function(t){e.chatOut(e.currentChat,!0)}}},[e._v("结束当前对话")])]),e._v(" "),s("div",{staticClass:"message-box-tools"},[s("div",{staticClass:"message-box-tools-input"},[s("textarea",{directives:[{name:"model",rawName:"v-model",value:e.message,expression:"message"}],staticClass:"form-control",staticStyle:{resize:"none"},attrs:{rows:"3"},domProps:{value:e.message},on:{keydown:function(t){if(!("button"in t)&&e._k(t.keyCode,"enter",13,t.key,"Enter"))return null;e.chatSubmit(e.currentChat.username,t)},input:function(t){t.target.composing||(e.message=t.target.value)}}},[e._v("输入内容")])]),e._v(" "),s("div",{staticClass:"message-box-tools-btn"},[s("button",{staticClass:"btn btn-success px-1",attrs:{type:"button"},on:{click:function(t){e.chatSubmit(e.currentChat.username,t)}}},[e._v("发 送")])])])],1)])])],1)},[],!1,null,null,null);_.options.__file="home.vue";t.default=_.exports}}]);